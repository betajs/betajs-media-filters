/*!
betajs-media-filters - v0.0.03 - 2017-03-01
Copyright (c) Ziggeo,Oliver Friedmann
Apache-2.0 Software License.
*/
(function(){var a=this.subScope();a.binding("module","global:BetaJS.MediaFilters"),a.binding("media","global:BetaJS.Media"),a.binding("base","global:BetaJS"),a.binding("browser","global:BetaJS.Browser"),a.binding("jquery","global:jQuery"),a.define("module:",function(){return{guid:"8475efdb-dd7e-402e-9f50-36c76945a692",version:"0.0.03"}}),a.assumeVersion("base:version","~1.0.96"),a.assumeVersion("browser:version","~1.0.61"),a.assumeVersion("media:version","~0.0.45"),a.define("module:FilterManager",["module:Filters","module:FilterSupport"],function(a,b){return{applyFilter:function(c,d){var e=".ba-video-"+d._stream.id.replace(/[{()}]/g,""),f=document.querySelector(e);return f||(f=b.createFilterCanvas(d),a[c](d,f)),!1},destroyFilter:function(a){var b=".ba-video-"+a._stream.id.replace(/[{()}]/g,""),c=document.querySelector(b);c&&(c.remove(),a._video.style.display="block")}}}),a.define("module:FilterSupport",[],function(){return{createFilterCanvas:function(a){var b=a._video,c=b.parentNode,d=b.clientHeight,e=b.clientWidth,f="ba-video-"+a._stream.id;return canvas||(canvas=document.createElement("canvas")),canvas.height=d,canvas.width=e,c.appendChild(canvas),canvas.className=f,b.style.display="none",canvas},filterTask:function(a,b,c){var d,e,f,g=a._video,h=!1;b||this.createFilterCanvas(a);const i=function j(){f||(f=b.getContext("2d")),d||(d=document.createElement("canvas"),e=d.getContext("2d"),d.width=b.width,d.height=b.height),e.drawImage(g,0,0,d.width,d.height);const a=e.getImageData(0,0,d.width,d.height),i=c(a);f.putImageData(i,0,0),h?(d=null,e=null,f=null):requestAnimationFrame(j)};return requestAnimationFrame(i),{stop:function(){h=!0}}},colourShift:function(a,b,c,d,e){const f=new Uint8ClampedArray(e.data.length);for(var g=0;g<e.data.length;g+=4)f[g]=Math.min(255,e.data[g]+a),f[g+1]=Math.max(0,Math.min(255,e.data[g+1]+b)),f[g+2]=Math.max(0,Math.min(255,e.data[g+2]+c)),f[g+3]=Math.max(0,Math.min(255,e.data[g+3]+d));const h=new ImageData(f,e.width,e.height);return h},colourFilter:function(a,b,c,d,e,f){return this.filterTask(e,f,this.colourShift.bind(this,a,b,c,d))},filterCanvasControl:function(a,b){var c=b||25,d=".ba-video-"+a.id.replace(/[{()}]/g,""),e=document.querySelector(d);return e&&(a=e.captureStream(c),e.className="ba-video-"+a.id.replace(/[{()}]/g,"")),a}}}),a.define("module:Filters",["module:FilterSupport"],function(a,b){return{invert:function(b,c){const d=function(a){const b=new Uint8ClampedArray(a.data.length);for(var c=0;c<a.data.length;c+=4)b[c]=255-a.data[c],b[c+1]=255-a.data[c+1],b[c+2]=255-a.data[c+2],b[c+3]=a.data[c+3];const d=new ImageData(b,a.width,a.height);return d};return a.filterTask(b,c,d)},red:function(b,c){a.colourFilter(150,0,0,0,b,c)},green:function(b,c){a.colourFilter(0,150,0,0,b,c)},blue:function(b,c){a.colourFilter(0,0,150,0,b,c)},none:function(a,b){},grayscale:function(b,c){const d=function(a){const b=tracking.Image.grayscale(a.data,a.width,a.height,!0);return new ImageData(b,a.width,a.height)};return a.filterTask(b,c,d)},blur:function(b,c){const d=function(a){const b=tracking.Image.blur(a.data,a.width,a.height,50);return new ImageData(new Uint8ClampedArray(b),a.width,a.height)};return a.filterTask(b,c,d)},sketch:function(b,c){const d=function(a){const b=tracking.Image.sobel(a.data,a.width,a.height);return new ImageData(new Uint8ClampedArray(b),a.width,a.height)};return a.filterTask(b,c,d)},face:function(b,c,d){var e,f,g,h,i,j=[];const k=function(a){return{array:a,width:c.width,height:c.height}},l=function(a){return h=k(a.data),i||(i=new Worker("../vendors/face-worker.js"),i.addEventListener("message",function(a){j=a.data.length?a.data:[],h&&i.postMessage(h)}),i.postMessage(h)),e||(e=document.createElement("canvas"),f=e.getContext("2d"),e.width=c.width,e.height=c.height,g=document.createElement("img"),g.src=d||"../vendors/images/comedy-glasses.png"),f.putImageData(a,0,0),j.forEach(function(a){f.drawImage(g,a.x,a.y,a.width,a.height)}),f.getImageData(0,0,e.width,e.height)},m=a.filterTask(b,c,l);return{stop:function(){m.stop()}}},eye:function(a,b){var c,d;a._video;c||(c=document.createElement("canvas"),d=c.getContext("2d"),c.width=b.width,c.height=b.height)}}}),a.define("module:StreamsFilter",["media:WebRTC.RecorderWrapper","module:FilterSupport"],function(a,b,c){return a.extend({scoped:c},function(a){return{constructor:function(b){a.constructor.call(this,b)},applyFilteredStream:function(a,c){return a._stream=b.filterCanvasControl(a._stream,c),a._whammyRecorder._stream=a._stream,a}}})})}).call(Scoped);